{"version":3,"file":"pdf.min.js","sources":["../src/pdf/pdf-view.js"],"sourcesContent":["import { LitElement, html, css } from 'lit-element';\nimport { styles } from 'wgnhs-common';\nexport { AppCollapsible } from 'wgnhs-layout';\nexport { ButtonLink } from 'wgnhs-layout';\nexport { AppSpinner } from 'wgnhs-layout';\n\n\nconst pdfjsLib = window['pdfjs-dist/build/pdf'];\n\nconst TOGGLE_EVENT = 'toggle-pdf-panel';\n\nclass PDFRenderer {\n  render(url) {\n    if (url) {\n      let canvasEl = document.createElement('canvas');\n      let loadingTask = pdfjsLib.getDocument(url);\n      return loadingTask.promise.then(function(pdf) {\n        // console.log('PDF Loaded');\n        var pageNumber = 1;\n        return pdf.getPage(pageNumber);\n      }).then(function(page) {\n        // console.log('Page loaded');\n        \n        var scale = 1.0;\n        var viewport = page.getViewport({scale: scale});\n\n        // Prepare canvas using PDF page dimensions\n        var canvas = canvasEl;\n        var context = canvas.getContext('2d');\n        canvas.height = viewport.height;\n        canvas.width = viewport.width;\n\n        // Render PDF page into canvas context\n        var renderContext = {\n          canvasContext: context,\n          viewport: viewport\n        };\n        var renderTask = page.render(renderContext);\n        return renderTask.promise;\n      }).then(function () {\n        // console.log('Page rendered');\n        let durl = canvasEl.toDataURL();\n        return durl;\n      });\n    }\n    return Promise.reject(null);\n  }\n}\n\nexport class PDFViewPanel extends LitElement {\n  static get properties() {\n    return {\n      pdfsrc: {\n        type: String,\n        attribute: false\n      },\n      rotate: {\n        type: Number\n      },\n      preserveRotate: {\n        type: Boolean,\n        attribute: 'preserve-rotate'\n      },\n      zoom: {\n        type: Number\n      },\n      preserveZoom: {\n        type: Boolean,\n        attribute: 'preserve-zoom'\n      }\n    };\n  }\n\n  constructor() {\n    super();\n    this.cache = {};\n    this.renderer = new PDFRenderer();\n    this.rotate = PDFViewPanel.INITIAL_ROTATE;\n    this.zoom = PDFViewPanel.INITIAL_ZOOM;\n  }\n\n  static get styles() {\n    return [\n      ...styles,\n      css`\n    .container {\n      min-height: 10em;\n      width: 100%;\n      display: grid;\n      grid-column-template: 1fr;\n      grid-gap: var(--border-radius);\n      justify-content: center;\n      overflow: auto;\n    }\n    .content {\n      max-width: 100%;\n      padding: var(--border-radius);\n      box-sizing: border-box;\n    }\n    .controls {\n      display: grid;\n      grid-column-template: 1fr;\n      grid-gap: var(--border-radius);\n      position: absolute;\n      top: 0;\n      right: var(--border-radius);\n      margin: var(--border-radius);\n      z-index: 10;\n    }\n    .control {\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      font-size: var(--icon-size-large);\n      color: var(--palette-accent);\n      text-align: center;\n      cursor: pointer;\n      padding: var(--border-radius);\n      background-color: var(--palette-light);\n      border: none;\n      border-radius: 50%;\n    }\n    .control:hover {\n      color: var(--el-color-hover, var(--palette-900));\n    }\n    [data-closed] {\n      display: none;\n    }\n    `];\n  }\n\n  render() {\n    return html`\n    <div class=\"controls\">\n      <button class=\"control\" @click=${this.hide}><i class=\"material-icons\" title=\"Hide\">close</i></button>\n      <button class=\"control\" @click=${this.zoomIn} ?disabled=${this.isMaxZoom}><i class=\"material-icons\" title=\"Zoom In\">zoom_in</i></button>\n      <button class=\"control\" @click=${this.zoomOut} ?disabled=${this.isMinZoom}><i class=\"material-icons\" title=\"Zoom Out\">zoom_out</i></button>\n      <button class=\"control\" @click=${this.rotateLeft}><i class=\"material-icons\" title=\"Rotate Left\">rotate_left</i></button>\n      <button class=\"control\" @click=${this.rotateRight}><i class=\"material-icons\" title=\"Rotate Right\">rotate_right</i></button>\n    </div>\n    <app-spinner ?data-closed=${this.imgsrc}></app-spinner>\n    <div class=\"container\" ?data-closed=${!this.imgsrc}>\n      ${this.imageTag}\n      <slot></slot>\n    </div>\n    `;\n  }\n\n  get imgsrc() {\n    return this.cache[this.pdfsrc];\n  }\n\n  static get MOD_ROTATE() {\n    return 4;\n  }\n\n  static get INITIAL_ROTATE() {\n    return 0;\n  }\n\n  get rotate() {\n    return this._rotate;\n  }\n  set rotate(val) {\n    const old = this.rotate;\n    let rot = Math.round(val) + PDFViewPanel.MOD_ROTATE;\n    this._rotate = (rot % PDFViewPanel.MOD_ROTATE);\n    this.requestUpdate('rotate', old);\n  }\n\n  rotateLeft() {\n    this.rotate -= 1;\n  }\n  rotateRight() {\n    this.rotate += 1;\n  }\n\n  static get MAX_ZOOM() {\n    return 3;\n  }\n  get isMaxZoom() {\n    return this.zoom >= PDFViewPanel.MAX_ZOOM;\n  }\n\n  static get MIN_ZOOM() {\n    return 0.5;\n  }\n  get isMinZoom() {\n    return this.zoom <= PDFViewPanel.MIN_ZOOM;\n  }\n\n  static get INITIAL_ZOOM() {\n    return 1;\n  }\n\n  get zoom() {\n    return this._zoom;\n  }\n  set zoom(val) {\n    const old = this.zoom;\n    this._zoom = Math.min(Math.max(val, PDFViewPanel.MIN_ZOOM), PDFViewPanel.MAX_ZOOM);\n    this.requestUpdate('zoom', old);\n  }\n\n  zoomIn() {\n    this.zoom += 0.25;\n  }\n  zoomOut() {\n    this.zoom -= 0.25;\n  }\n\n  get translate() {\n    let result = {\n      x: 0,\n      y: 0\n    };\n    if (this.rotate) {\n      result.x = (this.rotate === 1)? 0 : (100 * this.zoom);\n      result.y = (this.rotate === 3)? 0 : (100 * this.zoom);\n    }\n    return result;\n  }\n\n  get imageTag() {\n    return (!this.imgsrc)?'':html`\n    <img class=\"content\"\n      src=\"${this.imgsrc}\"\n      style=\"${this.contentTransform}\" />\n    `;\n  }\n\n  get contentTransform() {\n    let rot = this.rotate / PDFViewPanel.MOD_ROTATE;\n    let zoom = this.zoom;\n    let fix = this.translate;\n    let result = `\n      transform-origin: top left;\n      transform: rotate(${rot}turn) translate(-${fix.x}%, -${fix.y}%) scale(${zoom})\n      `;\n\n    return result;\n  }\n\n  show(url) {\n    // console.log('show', url);\n    this.dispatchEvent(new CustomEvent(TOGGLE_EVENT,\n      {bubbles: true, composed: true, detail: {url, closed: false}}));\n    this.pdfsrc = url;\n    if (!this.preserveRotate) {\n      this.rotate = PDFViewPanel.INITIAL_ROTATE;\n    }\n    if (!this.preserveZoom) {\n      this.zoom = PDFViewPanel.INITIAL_ZOOM;\n    }\n  }\n\n  hide() {\n    // console.log('hide');\n    this.pdfsrc = null;\n    this.dispatchEvent(new CustomEvent(TOGGLE_EVENT,\n      {bubbles: true, composed: true, detail: {closed: true}}));\n  }\n\n  _getFromCache(url) {\n    return new Promise((resolve, reject) => {\n      let result = this.cache[url];\n      if (result) {\n        resolve(result);\n      } else {\n        reject('Not in cache');\n      }\n    });\n  }\n\n  request(url) {\n    // console.log('request', url);\n    return this._getFromCache(url).catch(() => {\n      return this.renderer.render(url).then((value) => {\n        this.cache[url] = value;\n        this.requestUpdate('cache');\n        return value;\n      });\n    });\n  }\n\n}\ncustomElements.define('pdf-view-panel', PDFViewPanel);\n\nexport class PDFViewButton extends LitElement {\n  static get properties() {\n    return {\n      src: {\n        type: String\n      },\n      panel: {\n        type: Object,\n        attribute: false\n      },\n      missing: {\n        type: Boolean,\n        attribute: false\n      }\n    };\n  }\n\n  constructor() {\n    super();\n    this.missing = true;\n    this.alt = false;\n  }\n\n  static get styles() {\n    return [\n      ...styles,\n      css`\n    .container {\n      display: grid;\n      grid-template-columns: 1fr 1fr;\n      grid-gap: var(--border-radius);\n    }\n\n    [data-closed] {\n      visibility: hidden;\n    }\n    `];\n  }\n\n  render() {\n    return html`\n    <div class=\"container\" ?data-closed=${this.missing}>\n      <button-link href=\"${this.src}\" target=\"_blank\" download>\n        <i slot=\"content-before\" class=\"material-icons\" title=\"Download\">save_alt</i>\n        <span slot=\"content\"><slot name=\"download-text\">Download</slot></span>\n      </button-link>\n      <app-collapsible @open=\"${this.toggle}\" button>\n        <span slot=\"header\"><slot name=\"view-text\">View</slot></span>\n        <i slot=\"header-after\" class=\"material-icons\" title=\"View\">${\n          (this.alt)?'chevron_left':'chevron_right'\n        }</i>\n      </app-collapsible>\n    </div>\n    `;\n  }\n\n  updated(prev) {\n    if ((prev.has('panel') || prev.has('src'))) {\n      this.handleMissingPDF();\n      if (this.panel && this.src) {\n        this.panel.request(this.src)\n          .then(this.handleLoadedPDF.bind(this), this.handleMissingPDF.bind(this));\n      }\n    }\n  }\n\n  toggle(e) {\n    if (this.alt) {\n      this.panel.hide();\n    } else {\n      this.panel.show(this.src);\n    }\n  }\n\n  handleMissingPDF() {\n    if (!this.missing) {\n      this.missing = true;\n    }\n  }\n\n  handleLoadedPDF() {\n    if (this.missing) {\n      this.missing = false;\n    }\n  }\n\n  handleAlt(e) {\n    if (e.detail.url === this.src) {\n      this.alt = true;\n    } else {\n      this.alt = false;\n    }\n    this.requestUpdate();\n  }\n\n  connectedCallback() {\n    super.connectedCallback();\n    this.__altHandler = this.handleAlt.bind(this);\n    document.addEventListener(TOGGLE_EVENT, this.__altHandler);\n  }\n\n  disconnectedCallback() {\n    document.removeEventListener(TOGGLE_EVENT, this.__altHandler);\n    super.disconnectedCallback();\n  }\n}\ncustomElements.define('pdf-view-button', PDFViewButton);"],"names":["pdfjsLib","window","TOGGLE_EVENT","PDFRenderer","[object Object]","url","canvasEl","document","createElement","getDocument","promise","then","pdf","getPage","page","viewport","getViewport","scale","canvas","context","getContext","height","width","renderContext","canvasContext","render","toDataURL","Promise","reject","PDFViewPanel","LitElement","properties","pdfsrc","type","String","attribute","rotate","Number","preserveRotate","Boolean","zoom","preserveZoom","super","this","cache","renderer","INITIAL_ROTATE","INITIAL_ZOOM","styles","css","html","hide","zoomIn","isMaxZoom","zoomOut","isMinZoom","rotateLeft","rotateRight","imgsrc","imageTag","MOD_ROTATE","_rotate","val","old","rot","Math","round","requestUpdate","MAX_ZOOM","MIN_ZOOM","_zoom","min","max","translate","result","x","y","contentTransform","fix","dispatchEvent","CustomEvent","bubbles","composed","detail","closed","resolve","_getFromCache","catch","value","customElements","define","PDFViewButton","src","panel","Object","missing","alt","toggle","prev","has","handleMissingPDF","request","handleLoadedPDF","bind","e","show","connectedCallback","__altHandler","handleAlt","addEventListener","removeEventListener","disconnectedCallback"],"mappings":"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"}